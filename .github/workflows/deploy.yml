name: Deploy to PythonAnywhere

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Test SSH Connection
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PA_SSH_HOST }}
          username: ${{ secrets.PA_USERNAME }}
          key: ${{ secrets.PA_SSH_PRIVATE_KEY }}
          script: |
            echo "SSH connection successful!"
            echo "Connected as: $(whoami)"
            echo "Current directory: $(pwd)"
      
      - name: Deploy to PythonAnywhere
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PA_SSH_HOST }}
          username: ${{ secrets.PA_USERNAME }}
          key: ${{ secrets.PA_SSH_PRIVATE_KEY }}
          script: |
            # Navigate to your project directory
            cd ${{ secrets.PA_WORKING_DIRECTORY }}
            
            # Pull latest code from GitHub
            git pull origin main
            
            # Activate virtual environment and install/update dependencies
            source ${{ secrets.PA_VENV_DIRECTORY }}/bin/activate
            pip install -r requirements.txt
            
            # Reload the web app by touching the WSGI file
            touch ${{ secrets.PA_WSGI_FILE }}
            
            echo "Deployment completed successfully!"
